<!DOCTYPE html>
<html>
<head>
    <title>Form Kurasi IFP</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* (Salin seluruh CSS yang dipercantik dari jawaban sebelumnya di buildKurasiHtml) */
        :root { --primary-color: #28a745; --danger-color: #dc3545; --bg-light: #f4f6f9; --border-color: #ced4da; }
        body { font-family: 'Roboto', Arial, sans-serif; padding: 15px; background-color: var(--bg-light); }
        h3 { color: #1e3a5f; margin-top: 0; padding-bottom: 5px; border-bottom: 2px solid #1e3a5f; }
        #meta { background-color: #e9ecef; padding: 10px; margin-bottom: 15px; border-radius: 5px; font-size: 14px; color: #333; }
        .question { margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 6px; background-color: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        label { font-weight: 700; display: block; margin-bottom: 6px; color: #000; font-size: 15px; }
        select { padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; width: 100%; margin-bottom: 8px; appearance: none; background: #fff url('data:image/svg+xml;utf8,<svg fill="%23444444" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>') no-repeat right 8px center; background-size: 12px; }
        textarea { width: 100%; height: 70px; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; resize: vertical; font-family: Arial, sans-serif; }
        .note-label { font-weight: 400 !important; color: #555; margin-top: 5px; font-size: 14px; }
        .actions { margin-top: 20px; text-align: right; }
        .actions button { padding: 10px 20px; margin-left: 10px; border: none; border-radius: 5px; cursor: pointer; font-weight: 700; transition: background-color 0.2s, box-shadow 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        #submitBtn { background-color: var(--primary-color); color: white; }
        #submitBtn:hover { background-color: #1e7e34; }
        #submitBtn:disabled { background-color: #6c757d; cursor: not-allowed; }
        #cancelBtn { background-color: var(--danger-color); color: white; }
        #cancelBtn:hover { background-color: #c82333; }
    </style>
</head>
<body>
    <h3>üìù Form Kurasi</h3>
    <div id="meta">Memuat...</div>
    <div id="contentMeta" style="font-style:italic; margin-bottom:15px"></div>
    <div id="formArea"></div>
    <div class="actions">
        <button id="cancelBtn">Batal</button>
        <button id="submitBtn">Kirim Hasil Kurasi</button>
    </div>

    <script>
        // PASTE URL WEB APP ANDA DI SINI!
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxYrmCHAafei_NQerCeia256Q6KmNhUGjB7XlcxvuotXfL84b23zuFm5V-GyXZ1P7vx/exec';
        let currentPayload = {}; // Untuk menyimpan payload global

        // --- 1. Ambil Payload Kurasi ---
        async function fetchKurasiPayload() {
            const row = localStorage.getItem('current_kurasi_row');
            const kurator = localStorage.getItem('current_kurator_name');

            if (!row || !kurator) {
                alert('Data kurasi tidak ditemukan. Kembali ke halaman login.');
                window.location.href = 'index.html';
                return;
            }

            try {
                // Gunakan GET untuk mengambil pertanyaan dan detail konten
                const response = await fetch(WEB_APP_URL + `?action=fetchKurasiPayload&row=${row}`);
                const payload = await response.json();
                
                if(payload.error){ throw new Error(payload.error); }

                currentPayload = { ...payload, kurator: kurator }; // Tambahkan kurator name dari localStorage
                return currentPayload;

            } catch (e) {
                console.error('Gagal mengambil payload:', e);
                document.getElementById('meta').textContent = `Gagal memuat data: ${e.message}`;
                return null;
            }
        }

        // --- 2. Inisialisasi dan Render Form ---
        async function init() {
            const payload = await fetchKurasiPayload();
            if (!payload) return;

            document.getElementById('meta').innerHTML = `<b>Baris:</b> ${payload.row} &nbsp; | &nbsp; <b>Kurator:</b> ${payload.kurator}`;
            document.getElementById('contentMeta').innerHTML = `**Judul:** ${payload.meta.judul} | **Pengembang:** ${payload.meta.pengembang}`;

            renderForm(payload.questions);
        }

        function renderForm(questions) {
            const area = document.getElementById('formArea');
            area.innerHTML = '';
            if (!questions || questions.length === 0) { area.textContent = 'Tidak ada pertanyaan.'; return; }
            questions.forEach(function(q, idx) {
                const wrapper = document.createElement('div'); wrapper.className = 'question';
                const label = document.createElement('label'); label.textContent = `${idx + 1}. ${q}`; wrapper.appendChild(label);
                const sel = document.createElement('select'); sel.name = 'q_' + idx;
                ['', 'Ya', 'Tidak'].forEach(function(v) { const o = document.createElement('option'); o.value = v; o.text = v || '--Pilih--'; sel.appendChild(o); });
                wrapper.appendChild(sel);
                const noteLabel = document.createElement('label'); noteLabel.textContent = 'Catatan (opsional):'; noteLabel.className = 'note-label';
                wrapper.appendChild(noteLabel);
                const ta = document.createElement('textarea'); ta.name = 'note_' + idx; wrapper.appendChild(ta);
                area.appendChild(wrapper);
            });
        }

        // --- 3. Proses Kirim Data (POST) ---
        async function submitKurasi() {
            if (!currentPayload || !currentPayload.questions) { alert('Gagal memuat payload.'); return; }
            
            const questions = currentPayload.questions;
            const answers = questions.map(function(_, i) { const el = document.querySelector(`select[name="q_${i}"]`); return el ? el.value : ''; });
            const notes = questions.map(function(_, i) { const el = document.querySelector(`textarea[name="note_${i}"]`); return el ? el.value : ''; });
            const komentar = ''; // Jika Anda ingin menambahkan field Komentar umum
            
            for (var i = 0; i < answers.length; i++) { 
                if (!answers[i]) { 
                    if (!confirm(`Pertanyaan ke-${i + 1} belum dijawab. Lanjutkan?`)) return; 
                } 
            }

            document.getElementById('submitBtn').disabled = true;

            const submitData = {
                action: 'processKurasi',
                payload: {
                    row: currentPayload.row,
                    kurator: currentPayload.kurator,
                    answers: answers,
                    notes: notes,
                    komentar: komentar
                }
            };
            
            try {
                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' }, // Penting untuk Apps Script doPost
                    body: JSON.stringify(submitData)
                });
                
                const res = await response.json();
                
                if(res.error){ throw new Error(res.error); }

                alert(`Tersimpan pada baris HasilKurasi: ${res.row}`);
                localStorage.removeItem('current_kurasi_row');
                localStorage.removeItem('current_kurator_name');
                window.location.href = 'index.html';

            } catch (e) {
                alert(`Gagal menyimpan: ${e.message}`);
                document.getElementById('submitBtn').disabled = false;
                console.error('Submit error:', e);
            }
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('submitBtn').addEventListener('click', submitKurasi);
            document.getElementById('cancelBtn').addEventListener('click', function() {
                if(confirm('Apakah Anda yakin ingin membatalkan dan kembali ke daftar?')){
                    localStorage.removeItem('current_kurasi_row');
                    localStorage.removeItem('current_kurator_name');
                    window.location.href = 'index.html';
                }
            });
            init();
        });
    </script>
</body>

</html>


